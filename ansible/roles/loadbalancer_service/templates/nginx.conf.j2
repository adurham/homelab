# ACL: Define Internal Networks
geo $is_internal {
    default 0;
    192.168.86.0/24 1;  # LAN
    172.16.0.0/24   1;  # Private VLAN
    100.64.0.0/10   1;  # Tailscale
    127.0.0.0/8     1;  # Localhost
    ::1             1;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      "";
}

upstream proxmox_cluster {
    ip_hash;
    # Sticky sessions based on IP.
    # Note: With Tailscale Gateway (SNAT), all traffic might appear as 172.16.0.1.

    server 192.168.86.11:8006;
    server 192.168.86.12:8006;
    server 192.168.86.13:8006;

    keepalive 32;
}

upstream tanium_servers {
    ip_hash;
    server 172.16.0.51:443 max_fails=3 fail_timeout=10s;
    server 172.16.0.52:443 max_fails=3 fail_timeout=10s;
    keepalive 32;
}

server {
    listen 80;
    server_name tanium.chi.lab.amd-e.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name tanium.chi.lab.amd-e.com;

    ssl_certificate /etc/nginx/ssl/wildcard.fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/wildcard.key;

    # SSL Optimization
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_buffer_size 4k;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location / {
        proxy_pass https://tanium_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Websocket Support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Tanium uses self-signed internal certs
        proxy_ssl_verify off;
    }
}

server {
    listen 80;
    server_name proxmox.chi.lab.amd-e.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2 fastopen=3;
    server_name proxmox.chi.lab.amd-e.com;

    # ACL: Block external access
    if ($is_internal = 0) {
        return 403;
    }

    ssl_certificate /etc/nginx/ssl/wildcard.fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/wildcard.key;

    # SSL Optimization
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_buffer_size 4k;

    # Allow large uploads (ISOs)
    client_max_body_size 0;
    proxy_request_buffering off;

    # Extended timeouts for large file operations
    proxy_connect_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_read_timeout 3600s;

    # Proxy Configuration
    location = /redirect_oidc.html {
        alias /var/www/html/proxmox/redirect_oidc.html;
    }

    location / {
        proxy_pass https://proxmox_cluster;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Websocket Support (Critical for VNC)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Proxmox uses self-signed (or other) certs on backends
        proxy_ssl_verify off;
    }
}

server {
    listen 443 ssl http2;
    server_name whoami.chi.lab.amd-e.com;

    ssl_certificate /etc/nginx/ssl/wildcard.fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/wildcard.key;

    # Authentik Forward Auth
    location / {
        auth_request /outpost.goauthentik.io/auth/nginx;
        error_page 401 = @goauthentik_proxy_signin;
        auth_request_set $auth_cookie $upstream_http_set_cookie;
        add_header Set-Cookie $auth_cookie;

        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /outpost.goauthentik.io {
        proxy_pass https://auth.chi.lab.amd-e.com/outpost.goauthentik.io;
        proxy_set_header Host auth.chi.lab.amd-e.com;
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
    }

    location @goauthentik_proxy_signin {
        internal;
        add_header Set-Cookie $auth_cookie;
        return 302 /outpost.goauthentik.io/start?rd=$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name auth.chi.lab.amd-e.com;

    ssl_certificate /etc/nginx/ssl/wildcard.fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/wildcard.key;

    # SSL Optimization
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_buffer_size 4k;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/ssl/wildcard.fullchain.cer;
    resolver 1.1.1.1 8.8.8.8 valid=300s;
    resolver_timeout 5s;

    # HSTS (Strict-Transport-Security)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    location / {
        proxy_pass https://172.16.0.20;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;

        # Authentik (internal) uses self-signed/internal certs
        proxy_ssl_verify off;

        # Keepalive Support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}

server {
    listen 80;
    server_name grafana.chi.lab.amd-e.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name grafana.chi.lab.amd-e.com;

    # ACL: Block external access
    if ($is_internal = 0) {
        return 403;
    }

    ssl_certificate /etc/nginx/ssl/wildcard.fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/wildcard.key;

    location / {
        proxy_pass http://172.16.0.41:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name victoriametrics.chi.lab.amd-e.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name victoriametrics.chi.lab.amd-e.com;

    # ACL: Block external access
    if ($is_internal = 0) {
        return 403;
    }

    ssl_certificate /etc/nginx/ssl/wildcard.fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/wildcard.key;

    location / {
        proxy_pass http://172.16.0.40:8428;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
