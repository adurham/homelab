---
- name: Install dependencies
  ansible.builtin.apt:
    name:
      - nginx
      - git
      - socat
      - curl
    state: present
    update_cache: true

- name: Create SSL Directory
  ansible.builtin.file:
    path: /etc/nginx/ssl
    state: directory
    mode: '0755'

- name: Install acme.sh
  ansible.builtin.shell: >
    curl https://get.acme.sh | sh -s email=admin@lab.amd-e.com
  args:
    creates: /root/.acme.sh/acme.sh

- name: Register ACME Account (Let's Encrypt)
  ansible.builtin.shell: >
    /root/.acme.sh/acme.sh --register-account -m admin@lab.amd-e.com --server letsencrypt
  register: acme_reg
  changed_when: "'Account created' in acme_reg.stdout"
  failed_when: acme_reg.rc != 0 and "already registered" not in acme_reg.stdout and "Account already exists" not in acme_reg.stderr

- name: Issue Certificate (DNS-01 Wildcard)
  ansible.builtin.shell: >
    /root/.acme.sh/acme.sh --issue 
    --server letsencrypt
    --dns dns_desec 
    -d "*.chi.lab.amd-e.com"
    -d chi.lab.amd-e.com
  environment:
    DEDYN_TOKEN: "{{ acme_dedyn_token_proxmox }}"
    noip_username: "{{ noip_username }}"
    noip_password: "{{ noip_password }}"
  register: acme_issue
  changed_when: "'Cert success' in acme_issue.stdout"
  failed_when: acme_issue.rc != 0 and "Domains not changed" not in acme_issue.stdout

- name: Install Certificate to Nginx (Wildcard)
  ansible.builtin.shell: >
    /root/.acme.sh/acme.sh --install-cert -d "*.chi.lab.amd-e.com"
    --key-file       /etc/nginx/ssl/wildcard.key  
    --fullchain-file /etc/nginx/ssl/wildcard.fullchain.cer 
    --reloadcmd     "systemctl reload nginx"
  when: acme_issue.changed

- name: Deploy WhoAmI Script
  ansible.builtin.template:
    src: whoami.py.j2
    dest: /usr/local/bin/whoami.py
    mode: '0755'
  notify: Restart WhoAmI

- name: Deploy WhoAmI Service
  ansible.builtin.template:
    src: whoami.service.j2
    dest: /etc/systemd/system/whoami.service
    mode: '0644'
  notify: Restart WhoAmI

- name: Start WhoAmI Service
  ansible.builtin.systemd:
    name: whoami
    state: started
    enabled: true
    daemon_reload: true

- name: Add Authentik to Hosts File
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "172.16.0.20 auth.chi.lab.amd-e.com"
    state: present

- name: Deploy Nginx Configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/proxmox
  notify: Restart Nginx

- name: Enable Nginx Site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/proxmox
    dest: /etc/nginx/sites-enabled/proxmox
    state: link
  notify: Restart Nginx

- name: Remove Default Site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Restart Nginx

- name: Create Proxmox Web Directory
  ansible.builtin.file:
    path: /var/www/html/proxmox
    state: directory
    mode: '0755'

- name: Deploy OIDC Redirect Page
  ansible.builtin.template:
    src: redirect_oidc.html.j2
    dest: /var/www/html/proxmox/redirect_oidc.html
    mode: '0644'

  notify: Restart Nginx

- name: Configure DDNS (No-IP)
  ansible.builtin.include_tasks: ddns.yml
