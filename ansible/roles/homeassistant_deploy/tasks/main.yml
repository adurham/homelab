- name: Load HA credentials from env file
  delegate_to: localhost
  shell: "grep -E '^(HA_URL|HA_TOKEN)=' {{ playbook_dir }}/../homeassistant/ha_config.env | sed 's/#.*//'"
  register: ha_env_vars
  changed_when: false
  ignore_errors: yes
  tags: ['always']

- name: Set HA facts
  set_fact:
    ha_token: "{{ item.split('=')[1] | default(omit) }}"
    ha_url: "{{ item.split('=')[1] | default(omit) }}"
  when: item.startswith('HA_TOKEN=') and 'ha_token' not in vars
  with_items: "{{ ha_env_vars.stdout_lines | default([]) }}"
  no_log: true

- name: Set HA URL fact
  set_fact:
    ha_url: "{{ item.split('=')[1] }}"
  when: item.startswith('HA_URL=')
  with_items: "{{ ha_env_vars.stdout_lines | default([]) }}"
  tags: ['always']

- name: Run pre-deployment checks
  import_tasks: pre_checks.yml
  tags: ['always', 'pre_check']

- name: Perform backups
  import_tasks: backup.yml
  tags: ['backup']
  when: not skip_backup | default(false)

- name: Deploy configuration files
  import_tasks: deploy.yml
  tags: ['deploy']

- name: Validate and restart Home Assistant
  import_tasks: validate_and_restart.yml
  tags: ['validate', 'restart']
