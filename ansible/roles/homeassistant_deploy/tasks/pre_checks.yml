---
- name: Run local yamllint
  delegate_to: localhost
  command: yamllint .
  args:
    chdir: "{{ playbook_dir }}/../homeassistant"
  register: lint_result
  changed_when: false
  failed_when: lint_result.rc != 0

- name: Check for remote configuration changes
  block:
    - name: Fetch remote configuration.yaml
      delegate_to: localhost
      shell: "scp -P {{ ansible_port }} -o StrictHostKeyChecking=no {{ ansible_user }}@{{ ansible_host }}:/config/configuration.yaml {{ playbook_dir }}/../remote_configuration.yaml.tmp"
      register: fetch_remote_config
      changed_when: false
      ignore_errors: yes

    - name: Run smart config comparison
      delegate_to: localhost
      command: "{{ playbook_dir }}/../homeassistant/venv/bin/python {{ role_path }}/files/check_config_diff.py {{ playbook_dir }}/../homeassistant/configuration.yaml {{ playbook_dir }}/../remote_configuration.yaml.tmp {{ playbook_dir }}/../homeassistant/secrets.yaml"
      register: config_diff_check
      changed_when: false
      failed_when: false

    - name: Fail if remote config has changed externally (and is not semantically equivalent)
      fail:
        msg: "Remote configuration.yaml differs from local version (even after secret expansion). Aborting to avoid overwriting external changes."
      when:
        - config_diff_check.rc != 0
        - not skip_config_check | default(false)

    - name: Cleanup temp file
      delegate_to: localhost
      file:
        path: "{{ playbook_dir }}/../remote_configuration.yaml.tmp"
        state: absent
      changed_when: false

- name: Validate InfluxDB configuration
  block:
    - name: Check InfluxDB host in configuration
      delegate_to: localhost
      shell: "grep -A 5 '^influxdb:' {{ playbook_dir }}/../homeassistant/configuration.yaml | grep 'host:' | awk '{print $2}'"
      register: influxdb_host
      changed_when: false

    - name: Fail if InfluxDB host is a Docker service name
      fail:
        msg: "InfluxDB host '{{ influxdb_host.stdout | default('') | trim }}' appears to be a Docker service name (matches pattern: 8 hex chars + dash + name). Home Assistant runs on the host, not in Docker. Use 'homeassistant.local' or the actual hostname/IP."
      when: 
        - influxdb_host.stdout | default('') | trim != ''
        - influxdb_host.stdout | default('') | trim | regex_search('^[a-f0-9]{8}-') is not none
        - not skip_influxdb_check | default(false)

    - name: Test InfluxDB connectivity
      delegate_to: localhost
      uri:
        url: "http://{{ influxdb_host.stdout.strip() | default('homeassistant.local') }}:8086/ping"
        method: GET
        status_code: [204, 200]
      register: influxdb_test
      failed_when: false
      changed_when: false
      when: not skip_influxdb_check | default(false)

    - name: Warn if InfluxDB is not reachable
      debug:
        msg: "WARNING: InfluxDB at {{ influxdb_host.stdout.strip() }}:8086 is not reachable. This may cause data recording issues."
      when:
        - influxdb_test.status | default(0) != 204
        - not skip_influxdb_check | default(false)
