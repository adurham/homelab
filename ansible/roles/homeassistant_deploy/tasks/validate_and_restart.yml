---
- name: Validate and Restart Block
  block:
    - name: Validate configuration via API
      delegate_to: localhost
      uri:
        url: "{{ ha_url }}/api/config/core/check_config"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_token }}"
          Content-Type: "application/json"
        return_content: yes
      register: config_check
      failed_when: config_check.status != 200 or (config_check.json.result | default('unknown')) != 'valid'
      when: not skip_ha_validation | default(false)

    - name: Debug validation response
      debug:
        var: config_check
      when: config_check is failed

    - name: Restart Home Assistant
      delegate_to: localhost
      command: "ssh -p {{ ansible_port }} -o StrictHostKeyChecking=no {{ ansible_user }}@{{ ansible_host }} \"ha core restart\""
      when: not skip_ha_validation | default(false)

    - name: Wait for Home Assistant to come back up
      delegate_to: localhost
      wait_for:
        host: "{{ ansible_host }}"
        port: 8123
        delay: 10
        timeout: 600
      when: not skip_ha_validation | default(false)

    - name: Update local remote snapshot
      delegate_to: localhost
      copy:
        src: "{{ playbook_dir }}/../homeassistant/configuration.yaml"
        dest: "{{ playbook_dir }}/../homeassistant/configuration.yaml.remote"

  rescue:
    - name: Restore from backup
      delegate_to: localhost
      shell: |
        ssh -p {{ ansible_port }} -o StrictHostKeyChecking=no {{ ansible_user }}@{{ ansible_host }} "
        latest_backup=\$(ha backups list --raw-json | jq -r '.data.backups[] | select(.type == \"full\") | .slug' | head -n 1)
        if [ -n \"\$latest_backup\" ] && [ \"\$latest_backup\" != \"null\" ]; then
            ha backups restore \"\$latest_backup\"
        else
            echo \"No full backup found to restore\"
            exit 1
        fi
        "
      register: restore_result
    
    - name: Fail after restore
      fail:
        msg: "Deployment failed validation or restart. System restored from backup. Restore output: {{ restore_result.stdout }}"
