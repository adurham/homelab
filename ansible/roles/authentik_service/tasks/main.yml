---
- name: Remove legacy Docker source list
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/docker.list
    state: absent

- name: Install dependencies (Nginx, Certs)
  ansible.builtin.apt:
    name:
      - curl
      - git
      - ca-certificates
      - gnupg
      - nginx
      - socat
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Add Docker GPG apt Key
  ansible.builtin.apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker Repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present

- name: Install Docker
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Install acme.sh (Clone Repo)
  ansible.builtin.git:
    repo: https://github.com/acmesh-official/acme.sh.git
    dest: /opt/acme.sh
    version: master
    depth: 1

- name: Install acme.sh (Run Installer)
  ansible.builtin.command:
    cmd: ./acme.sh --install -m admin@lab.amd-e.com
    chdir: /opt/acme.sh
  args:
    creates: /root/.acme.sh/acme.sh

- name: Create SSL Directory
  ansible.builtin.file:
    path: /etc/nginx/ssl
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Issue Certificate (DNS-01)
  ansible.builtin.shell: |
    export DEDYN_TOKEN="{{ acme_dedyn_token }}"
    /root/.acme.sh/acme.sh --issue \
      --dns dns_desec \
      -d auth.chi.lab.amd-e.com
  args:
    creates: /root/.acme.sh/auth.chi.lab.amd-e.com_ecc/auth.chi.lab.amd-e.com.key
  environment:
    DEDYN_TOKEN: "{{ acme_dedyn_token }}"
  no_log: true

- name: Install Certificate to Nginx
  ansible.builtin.shell: |
    /root/.acme.sh/acme.sh --install-cert -d auth.chi.lab.amd-e.com \
      --key-file       /etc/nginx/ssl/auth.key  \
      --fullchain-file /etc/nginx/ssl/fullchain.cer \
      --reloadcmd     "systemctl force-reload nginx"
  args:
    creates: /etc/nginx/ssl/auth.key

- name: Deploy Nginx Configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/authentik
    mode: '0644'
    owner: root
    group: root
  notify: Restart Nginx

- name: Enable Nginx Site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/authentik
    dest: /etc/nginx/sites-enabled/authentik
    state: link
  notify: Restart Nginx

- name: Remove Default Nginx Site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Restart Nginx

- name: Create Authentik Directory
  ansible.builtin.file:
    path: /opt/authentik
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Deploy Docker Compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /opt/authentik/docker-compose.yml
    mode: '0640'
    owner: root
    group: root

- name: Deploy .env file
  ansible.builtin.template:
    src: .env.j2
    dest: /opt/authentik/.env
    mode: '0600'
    owner: root
    group: root

- name: Start Authentik Configuration
  community.docker.docker_compose_v2:
    project_src: /opt/authentik
    state: present
  register: authentik_service_compose_result
