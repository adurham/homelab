---
# -------------------------------------------------------------------------
# SCIM Provider & Token Management
# -------------------------------------------------------------------------

# SCIM tasks disabled due to 405 errors
# - name: Get Existing Authentik SCIM Provider
#   ...

# -------------------------------------------------------------------------
# Core User/Group Management
# -------------------------------------------------------------------------

- name: Get Existing Admin Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/?search={{ group_admin_name | urlencode }}"
    method: GET
    headers: "{{ headers }}"
  register: group_admin_list

- name: Create Proxmox_Admins Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/"
    method: POST
    headers: "{{ headers }}"
    body_format: json
    body:
      name: "{{ group_admin_name }}"
      is_superuser: true
    status_code: [200, 201]
  when: group_admin_list.json.results | length == 0
  register: new_group_admin

- name: Capture Admin Group ID
  ansible.builtin.set_fact:
    group_admin_id: >-
      {{
        (new_group_admin.json.pk
          if (new_group_admin is defined and new_group_admin.changed)
          else group_admin_list.json.results[0].pk)
      }}

- name: Ensure Proxmox Admin Group Name (Rename)
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/{{ group_admin_id }}/"
    method: PATCH
    headers: "{{ headers }}"
    body_format: json
    body:
      name: "{{ group_admin_name }}"
    status_code: [200]
  when:
    - group_admin_list.json.results | length > 0
    - group_admin_list.json.results[0].name != group_admin_name

- name: Get Existing Users Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/?search={{ group_user_name | urlencode }}"
    method: GET
    headers: "{{ headers }}"
  register: group_user_list

- name: Create Proxmox_Users Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/"
    method: POST
    headers: "{{ headers }}"
    body_format: json
    body:
      name: "{{ group_user_name }}"
      is_superuser: false
    status_code: [200, 201]
  when: group_user_list.json.results | length == 0
  register: new_group_user

- name: Capture User Group ID
  ansible.builtin.set_fact:
    group_user_id: >-
      {{
        (new_group_user.json.pk
          if (new_group_user is defined and new_group_user.changed)
          else group_user_list.json.results[0].pk)
      }}

- name: Ensure Proxmox User Group Name (Rename)
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/{{ group_user_id }}/"
    method: PATCH
    headers: "{{ headers }}"
    body_format: json
    body:
      name: "{{ group_user_name }}"
    status_code: [200]
  when:
    - group_user_list.json.results | length > 0
    - group_user_list.json.results[0].name != group_user_name

- name: Get Existing Users
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/users/?search={{ user_username | urlencode }}"
    method: GET
    headers: "{{ headers }}"
  register: users_list

- name: Create Admin User
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/users/"
    method: POST
    headers: "{{ headers }}"
    body_format: json
    body:
      username: "{{ user_username }}"
      name: "{{ user_name }}"
      email: "{{ user_email }}"
      groups: ["{{ group_admin_id }}"]
    status_code: [200, 201]
  when: users_list.json.results | length == 0

# -------------------------------------------------------------------------
# Grafana Groups
# -------------------------------------------------------------------------

- name: Get Existing Grafana Admins Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/?search=Grafana%20Admins"
    method: GET
    headers: "{{ headers }}"
  register: grafana_admin_group_list

- name: Create Grafana Admins Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/"
    method: POST
    headers: "{{ headers }}"
    body_format: json
    body:
      name: "Grafana Admins"
      is_superuser: false
    status_code: [200, 201]
  when: grafana_admin_group_list.json.results | length == 0
  register: new_grafana_admin_group

- name: Get Existing Grafana Users Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/?search=Grafana%20Users"
    method: GET
    headers: "{{ headers }}"
  register: grafana_user_group_list

- name: Create Grafana Users Group
  ansible.builtin.uri:
    url: "{{ authentik_url }}/api/v3/core/groups/"
    method: POST
    headers: "{{ headers }}"
    body_format: json
    body:
      name: "Grafana Users"
      is_superuser: false
    status_code: [200, 201]
  when: grafana_user_group_list.json.results | length == 0
  register: new_grafana_user_group

# Membership managed manually
# (Admin User assignment removed per user request)
