---
- name: Manage Authentik Resources
  hosts: localhost
  connection: local
  gather_facts: false
  module_defaults:
    ansible.builtin.uri:
      validate_certs: true
  vars:
    authentik_url: "https://auth.chi.lab.amd-e.com"
    api_token: "{{ authentik_api_token }}"
    headers:
      Authorization: "Bearer {{ api_token }}"
      Content-Type: "application/json"

    # Configuration
    provider_name: "Proxmox"
    app_name: "Proxmox"
    app_slug: "proxmox"
    group_admin_name: "Proxmox Admins"
    group_user_name: "Proxmox Users"
    user_email: "admin@lab.amd-e.com"
    user_username: "admin"
    user_name: "Proxmox Admin"
    proxmox_redirect_uris: |
      https://proxmox.chi.lab.amd-e.com
      https://pve01.chi.lab.amd-e.com:8006
      https://pve02.chi.lab.amd-e.com:8006
      https://pve03.chi.lab.amd-e.com:8006
      https://192.168.86.11:8006
      https://192.168.86.12:8006
      https://192.168.86.13:8006
      https://172.16.0.30

    # Tanium Configuration
    tanium_url: "https://tanium.chi.lab.amd-e.com"
    tanium_acs_url: "https://tanium.chi.lab.amd-e.com/saml2/auth/custom"
    tanium_issuer: "https://tanium-prod.chi.lab.amd-e.com:17472/sp"
    tanium_app_slug: "tanium"
    tanium_app_name: "Tanium"

  tasks:
    - name: Get Existing Providers
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/oauth2/?search={{ provider_name | urlencode }}"
        method: GET
        headers: "{{ headers }}"
        return_content: true
      register: providers_list

    - name: Create Proxmox Provider
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/oauth2/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "{{ provider_name }}"
          authorization_flow: "default-provider-authorization-implicit-consent"
          authentication_flow: "default-authentication-flow"
          redirect_uris: "{{ proxmox_redirect_uris }}"
          client_type: "confidential"
          # signing_key defaults
        status_code: [200, 201]
      when: providers_list.json.results | length == 0
      register: new_provider

    - name: Update Proxmox Provider (Ensure Redirect URIs)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/oauth2/{{ providers_list.json.results[0].pk }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          redirect_uris: "{{ proxmox_redirect_uris }}"
        status_code: [200]
      when: providers_list.json.results | length > 0
      register: update_provider

    - name: Capture Provider ID
      ansible.builtin.set_fact:
        provider_id: "{{ (new_provider.json.pk if new_provider is defined and new_provider.changed else providers_list.json.results[0].pk) }}"

    - name: Get Proxmox Application (Direct)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/{{ app_slug }}/"
        method: GET
        headers: "{{ headers }}"
        status_code: [200, 404]
      register: get_app_direct

    - name: Create Proxmox Application
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "{{ app_name }}"
          slug: "{{ app_slug }}"
          provider: "{{ provider_id }}"
        status_code: [200, 201]
      when: get_app_direct.status == 404
      ignore_errors: true
      register: create_app

    - name: Update Proxmox Application (Ensure URL)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/{{ app_slug }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          launch_url: "https://proxmox.chi.lab.amd-e.com/redirect_oidc.html"
          open_in_new_tab: true
        status_code: [200]
      when: get_app_direct.status == 200 or (create_app is defined and not create_app.failed)

    - name: Capture Proxmox App ID
      ansible.builtin.set_fact:
        proxmox_app_id: "{{ (get_app_direct.json.pk if get_app_direct.status == 200 else create_app.json.pk) }}"

    # -------------------------------------------------------------------------
    # Tanium Integration (SAML)
    # -------------------------------------------------------------------------

    - name: Get Existing Tanium Provider
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/saml/?search=Tanium"
        method: GET
        headers: "{{ headers }}"
      register: tanium_provider_list
      
    - name: Get Self-signed Certificate
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/crypto/certificatekeypairs/?search=authentik%20Self-signed%20Certificate"
        method: GET
        headers: "{{ headers }}"
      register: signing_cert

    - name: Get Default Authentication Flow (Tanium)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=default-authentication-flow"
        method: GET
        headers: "{{ headers }}"
      register: tanium_auth_flow

    - name: Get Authorization Flow (Implict Consent)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=default-provider-authorization-implicit-consent"
        method: GET
        headers: "{{ headers }}"
      register: tanium_author_flow

    - name: Create Tanium SAML Provider
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/saml/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Tanium"
          authorization_flow: "{{ tanium_author_flow.json.results[0].pk }}"
          authentication_flow: "{{ tanium_auth_flow.json.results[0].pk }}"
          acs_url: "{{ tanium_acs_url }}"
          issuer: "{{ tanium_issuer }}"
          audience: "{{ tanium_issuer }}"
          sp_binding: "post"
          sign_assertion: true
          sign_response: true
          signing_kp: "{{ signing_cert.json.results[0].pk }}"
        status_code: [200, 201]
      when: tanium_provider_list.json.results | length == 0
      register: new_tanium_provider

    - name: Update Tanium SAML Provider (Ensure Settings)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/saml/{{ tanium_provider_list.json.results[0].pk }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          acs_url: "{{ tanium_acs_url }}"
          issuer: "{{ tanium_issuer }}"
          audience: "{{ tanium_issuer }}"
          sign_assertion: true
          sign_response: true
          signing_kp: "{{ signing_cert.json.results[0].pk }}"
        status_code: [200]
      when: tanium_provider_list.json.results | length > 0

    - name: Debug Tanium Creation
      ansible.builtin.debug:
        var: new_tanium_provider

    - name: Capture Tanium Provider ID (Created)
      ansible.builtin.set_fact:
        tanium_provider_id: "{{ new_tanium_provider.json.pk }}"
      when: new_tanium_provider is defined and new_tanium_provider.changed

    - name: Capture Tanium Provider ID (Existing)
      ansible.builtin.set_fact:
        tanium_provider_id: "{{ tanium_provider_list.json.results[0].pk }}"
      when: tanium_provider_id is not defined

    - name: Get Tanium Application (Direct)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/{{ tanium_app_slug }}/"
        method: GET
        headers: "{{ headers }}"
        status_code: [200, 404]
      register: get_tanium_app

    - name: Create Tanium Application
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "{{ tanium_app_name }}"
          slug: "{{ tanium_app_slug }}"
          provider: "{{ tanium_provider_id }}"
          meta_launch_url: "{{ tanium_url }}"
        status_code: [200, 201]
      when: get_tanium_app.status == 404
      register: create_tanium_app

    - name: Update Tanium Application (Ensure URL)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/{{ tanium_app_slug }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          meta_launch_url: "{{ tanium_url }}"
        status_code: [200]
      when: get_tanium_app.status == 200 or (create_tanium_app is defined and not create_tanium_app.failed)

    # -------------------------------------------------------------------------
    # Tanium Integration (SCIM)
    # -------------------------------------------------------------------------

    - name: Get Existing Authentik SCIM Provider
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/scim/?search=Tanium"
        method: GET
        headers: "{{ headers }}"
      register: authentik_scim_provider_list

    - name: Check Tanium REGARDLESS of Authentik state
      ansible.builtin.uri:
        url: "{{ tanium_url }}/api/v2/scim_servers"
        method: GET
        headers:
          session: "{{ vault_tanium_api_token }}"
      register: tanium_scim_servers

    - name: Create Tanium SCIM Token
      ansible.builtin.uri:
        url: "{{ tanium_url }}/api/v2/scim_servers"
        method: POST
        headers:
          session: "{{ vault_tanium_api_token }}"
        body_format: json
        body:
          expire_in_days: "365"
          name: "Authentik"
          trusted_ip_addresses: "172.16.0.20" # Authentik IP
        status_code: [200, 201]
      register: create_scim_token
      # Create if Tanium has no SCIM servers (e.g. deleted/rotated)
      when: tanium_scim_servers.json.data | length == 0

    - name: Set Tanium SCIM Token Fact
      ansible.builtin.set_fact:
        tanium_scim_token: "{{ create_scim_token.json.data.api_token.token_string }}"
      when: create_scim_token is defined and create_scim_token.changed

    - name: Create Tanium SCIM Provider
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/scim/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Tanium SCIM"
          url: "{{ tanium_url }}/scim/v2"
          token: "{{ create_scim_token.json.data.api_token.token_string }}"
        status_code: [200, 201]
      when: authentik_scim_provider_list.json.results | length == 0
      register: new_scim_provider

    - name: Debug SCIM Creation
      ansible.builtin.debug:
        var: new_scim_provider

    - name: Capture SCIM Provider ID (Created)
      ansible.builtin.set_fact:
        scim_provider_id: "{{ new_scim_provider.json.pk }}"
      when: new_scim_provider is defined and new_scim_provider.changed

    - name: Capture SCIM Provider ID (Existing)
      ansible.builtin.set_fact:
        scim_provider_id: "{{ authentik_scim_provider_list.json.results[0].pk }}"
      when: scim_provider_id is not defined

    # -------------------------------------------------------------------------
    # Update SCIM Provider with Mappings (Critical for Sync)
    # -------------------------------------------------------------------------

    - name: Get SCIM User Mapping
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/propertymappings/scim/?search=authentik%20default%20SCIM%20Mapping:%20User"
        method: GET
        headers: "{{ headers }}"
      register: scim_user_mapping

    - name: Get SCIM Group Mapping
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/propertymappings/scim/?search=authentik%20default%20SCIM%20Mapping:%20Group"
        method: GET
        headers: "{{ headers }}"
      register: scim_group_mapping

    - name: Get Custom SCIM Group Mapping (Filter)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/propertymappings/scim/?search=SCIM%20Mapping:%20Tanium%20Users%20Only"
        method: GET
        headers: "{{ headers }}"
      register: scim_filtered_group_mapping_list

    - name: Create Custom SCIM Group Mapping (Filter)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/propertymappings/scim/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "SCIM Mapping: Tanium Users Only"
          expression: |
            if group.name == "Tanium Users":
                return {
                    "displayName": group.name,
                }
            return None
        status_code: [200, 201]
      when: scim_filtered_group_mapping_list.json.results | length == 0
      register: create_scim_filtered_group_mapping

    - name: Capture Custom Group Mapping ID (Created)
      ansible.builtin.set_fact:
        scim_filtered_group_id: "{{ create_scim_filtered_group_mapping.json.pk }}"
      when: create_scim_filtered_group_mapping is defined and create_scim_filtered_group_mapping.changed

    - name: Capture Custom Group Mapping ID (Existing)
      ansible.builtin.set_fact:
        scim_filtered_group_id: "{{ scim_filtered_group_mapping_list.json.results[0].pk }}"
      when: scim_filtered_group_mapping_list.json.results | length > 0

    - name: Update Tanium SCIM Provider (Property Mappings)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/scim/{{ scim_provider_id }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          property_mappings: ["{{ scim_user_mapping.json.results[0].pk }}"]
          property_mappings_group: ["{{ scim_filtered_group_id }}"]
          exclude_users_service_account: true
          # Disable SSL verification to avoid internal cert trust issues
          verify_certificates: false
          # Update Token if we have a new one (omit if not defined)
          token: "{{ tanium_scim_token | default(omit) }}"
        status_code: [200]
      when: 
        - scim_user_mapping.json.results | length > 0 
        - scim_filtered_group_id is defined

    - name: Get Tanium SCIM Application
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/tanium-provisioning/"
        method: GET
        headers: "{{ headers }}"
        status_code: [200, 404]
      register: get_scim_app

    - name: Create Tanium SCIM Application
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Tanium Provisioning"
          slug: "tanium-provisioning"
          provider: "{{ scim_provider_id }}"
          meta_launch_url: "{{ tanium_url }}" # Not really used but good for reference
        status_code: [200, 201]
      when: get_scim_app.status == 404
      register: create_scim_app

    - name: Capture SCIM App ID
      ansible.builtin.set_fact:
        scim_app_id: "{{ (create_scim_app.json.pk if (create_scim_app is defined and create_scim_app.changed) else get_scim_app.json.pk) }}"

    # -------------------------------------------------------------------------
    # Tanium Sync Configuration (Group & Policy)
    # -------------------------------------------------------------------------

    - name: Get Tanium Users Group
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/?search=Tanium%20Users"
        method: GET
        headers: "{{ headers }}"
      register: tanium_users_group_list

    - name: Create Tanium Users Group
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Tanium Users"
          is_superuser: false
        status_code: [200, 201]
      when: tanium_users_group_list.json.results | length == 0
      register: new_tanium_users_group

    - name: Capture Tanium Users Group ID
      ansible.builtin.set_fact:
        tanium_users_group_id: "{{ (new_tanium_users_group.json.pk if (new_tanium_users_group is defined and new_tanium_users_group.changed) else tanium_users_group_list.json.results[0].pk) }}"

    # Direct Group Binding for SCIM Sync (Replaces Policy Binding)
    - name: Check Tanium Users Group Binding
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/bindings/?target={{ scim_app_id }}&group={{ tanium_users_group_id }}"
        method: GET
        headers: "{{ headers }}"
      register: tanium_group_binding

    - name: Bind Tanium Users Group to SCIM App
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ scim_app_id }}"
          group: "{{ tanium_users_group_id }}"
          order: 0
          enabled: true
        status_code: [200, 201]
      when: tanium_group_binding.json.results | length == 0

    # Clean up the Expression Policy (Optional but clean)
    - name: Delete Tanium Access Policy (Clean up)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/expression/{{ tanium_policy_id }}/"
        method: DELETE
        headers: "{{ headers }}"
        status_code: [204]
      # Only delete if we captured an ID and we are sure we want to remove it. 
      when: tanium_policy_id is defined
      ignore_errors: true

    



    - name: Get Existing Admin Group
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/?search={{ group_admin_name | urlencode }}"
        method: GET
        headers: "{{ headers }}"
      register: group_admin_list

    - name: Create Proxmox_Admins Group
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "{{ group_admin_name }}"
          is_superuser: true
        status_code: [200, 201]
      when: group_admin_list.json.results | length == 0
      register: new_group_admin

    - name: Capture Admin Group ID
      set_fact:
        group_admin_id: "{{ (new_group_admin.json.pk if (new_group_admin is defined and new_group_admin.changed) else group_admin_list.json.results[0].pk) }}"


    - name: Ensure Proxmox Admin Group Name (Rename)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/{{ group_admin_id }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "{{ group_admin_name }}"
        status_code: [200]
      when: 
        - group_admin_list.json.results | length > 0
        - group_admin_list.json.results[0].name != group_admin_name

    - name: Get Existing Users Group
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/?search={{ group_user_name | urlencode }}"
        method: GET
        headers: "{{ headers }}"
      register: group_user_list

    - name: Create Proxmox_Users Group
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "{{ group_user_name }}"
          is_superuser: false
        status_code: [200, 201]
      when: group_user_list.json.results | length == 0
      register: new_group_user

    - name: Capture User Group ID
      set_fact:
        group_user_id: "{{ (new_group_user.json.pk if (new_group_user is defined and new_group_user.changed) else group_user_list.json.results[0].pk) }}"

    - name: Ensure Proxmox User Group Name (Rename)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/groups/{{ group_user_id }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "{{ group_user_name }}"
        status_code: [200]
      when: 
        - group_user_list.json.results | length > 0
        - group_user_list.json.results[0].name != group_user_name


    - name: Get Existing Users
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/users/?search={{ user_username | urlencode }}"
        method: GET
        headers: "{{ headers }}"
      register: users_list

    - name: Create Admin User
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/users/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          username: "{{ user_username }}"
          name: "{{ user_name }}"
          email: "{{ user_email }}"
          groups: ["{{ group_admin_id }}"]
        status_code: [200, 201]
      when: users_list.json.results | length == 0

    # -------------------------------------------------------------------------
    # Recovery Flow Implementation
    # -------------------------------------------------------------------------

    - name: Get Identification Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/identification/?search=Recovery-Identification-Stage"
        method: GET
        headers: "{{ headers }}"
      register: stage_ident_list

    - name: Create Identification Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/identification/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Recovery-Identification-Stage"
          user_fields: ["username", "email"]
        status_code: [200, 201]
      when: stage_ident_list.json.results | length == 0
      register: new_stage_ident

    - name: Capture Identification Stage ID
      set_fact:
        stage_ident_id: "{{ (new_stage_ident.json.pk if (new_stage_ident is defined and new_stage_ident.json is defined) else stage_ident_list.json.results[0].pk) }}"

    - name: Get Email Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/email/?search=Recovery-Email-Stage"
        method: GET
        headers: "{{ headers }}"
      register: stage_email_list

    - name: Create Email Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/email/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Recovery-Email-Stage"
          use_global_settings: true
          # Subject/Template defaults are usually fine, relies on global SMTP
        status_code: [200, 201]
      when: stage_email_list.json.results | length == 0
      register: new_stage_email

    - name: Capture Email Stage ID
      set_fact:
        stage_email_id: "{{ (new_stage_email.json.pk if (new_stage_email is defined and new_stage_email.json is defined) else stage_email_list.json.results[0].pk) }}"

    # Prompts -----------------------------------------------------------------

    - name: Get Password Prompt
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/prompt/prompts/?search=Recovery-Password-Prompt"
        method: GET
        headers: "{{ headers }}"
      register: prompt_password_list

    - name: Create Password Prompt
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/prompt/prompts/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Recovery-Password-Prompt"
          field_key: "password"
          label: "Password"
          type: "password"
          required: true
          placeholder: "New Password"
          order: 0
        status_code: [200, 201]
      when: prompt_password_list.json.results | length == 0
      register: new_prompt_password

    - name: Capture Password Prompt ID
      set_fact:
        prompt_password_id: "{{ (new_prompt_password.json.pk if (new_prompt_password is defined and new_prompt_password.json is defined) else prompt_password_list.json.results[0].pk) }}"

    - name: Get Password Repeat Prompt
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/prompt/prompts/?search=Recovery-Password-Repeat-Prompt"
        method: GET
        headers: "{{ headers }}"
      register: prompt_repeat_list

    - name: Create Password Repeat Prompt
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/prompt/prompts/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Recovery-Password-Repeat-Prompt"
          field_key: "password_repeat"
          label: "Password (repeat)"
          type: "password"
          required: true
          placeholder: "Repeat Password"
          order: 1
        status_code: [200, 201]
      when: prompt_repeat_list.json.results | length == 0
      register: new_prompt_repeat

    - name: Capture Password Repeat Prompt ID
      set_fact:
        prompt_repeat_id: "{{ (new_prompt_repeat.json.pk if (new_prompt_repeat is defined and new_prompt_repeat.json is defined) else prompt_repeat_list.json.results[0].pk) }}"


    # Stages (Prompt & Write) -------------------------------------------------

    - name: Get Prompt Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/prompt/stages/?search=Recovery-Prompt-Stage"
        method: GET
        headers: "{{ headers }}"
      register: stage_prompt_list

    - name: Create Prompt Stage (Recovery)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/prompt/stages/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Recovery-Prompt-Stage"
          fields:
            - "{{ prompt_password_id }}"
            - "{{ prompt_repeat_id }}"
          validation_policies: []
        status_code: [200, 201]
      when: stage_prompt_list.json.results | length == 0
      register: new_stage_prompt

    - name: Capture Prompt Stage ID
      set_fact:
        stage_prompt_id: "{{ (new_stage_prompt.json.pk if (new_stage_prompt is defined and new_stage_prompt.json is defined) else stage_prompt_list.json.results[0].pk) }}"

    - name: Get User Write Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/user_write/?search=Recovery-Write-Stage"
        method: GET
        headers: "{{ headers }}"
      register: stage_write_list

    - name: Create User Write Stage (Recovery)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/user_write/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Recovery-Write-Stage"
          user_creation_mode: "never_create"
        status_code: [200, 201]
      when: stage_write_list.json.results | length == 0
      register: new_stage_write

    - name: Capture Write Stage ID
      set_fact:
        stage_write_id: "{{ (new_stage_write.json.pk if (new_stage_write is defined and new_stage_write.json is defined) else stage_write_list.json.results[0].pk) }}"

    - name: Get Recovery Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=recovery-flow"
        method: GET
        headers: "{{ headers }}"
      register: flow_recovery_list

    - name: Create Recovery Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Recovery Flow"
          slug: "recovery-flow"
          title: "Reset your password"
          designation: "recovery"
          authentication: "none"
        status_code: [200, 201]
      when: flow_recovery_list.json.results | length == 0
      register: new_flow_recovery

    - name: Capture Recovery Flow ID
      set_fact:
        flow_recovery_id: "{{ (new_flow_recovery.json.pk if (new_flow_recovery is defined and new_flow_recovery.json is defined) else flow_recovery_list.json.results[0].pk) }}"

    - name: Get Legacy Password Stage (Cleanup)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/password/?search=Recovery-Password-Stage"
        method: GET
        headers: "{{ headers }}"
      register: legacy_password_stage

    - name: Delete Legacy Password Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/password/{{ legacy_password_stage.json.results[0].pk }}/"
        method: DELETE
        headers: "{{ headers }}"
        status_code: [204]
      when: legacy_password_stage.json.results | length > 0
      ignore_errors: true

    # Bindings ----------------------------------------------------------------

    - name: Bind Identification Stage to Flow (Order 0)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_recovery_id }}"
          stage: "{{ stage_ident_id }}"
          order: 0
        status_code: [200, 201]
      ignore_errors: true # In case it already exists, simpler than checking for bindings which is noisy

    - name: Bind Email Stage to Flow (Order 10)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_recovery_id }}"
          stage: "{{ stage_email_id }}"
          order: 10
        status_code: [200, 201]
      ignore_errors: true

    - name: Bind Prompt Stage to Flow (Order 20)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_recovery_id }}"
          stage: "{{ stage_prompt_id }}"
          order: 20
        status_code: [200, 201]
      register: bind_prompt_result
      changed_when: bind_prompt_result.status == 201
      ignore_errors: true

    - name: Bind User Write Stage to Flow (Order 30)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_recovery_id }}"
          stage: "{{ stage_write_id }}"
          order: 30
        status_code: [200, 201]
      register: bind_write_result
      changed_when: bind_write_result.status == 201
      ignore_errors: true

    # Brand Update -----------------------------------------------------------

    - name: Get Default Brand
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/brands/"
        method: GET
        headers: "{{ headers }}"
      register: brand_list

    - name: Configure Brand (AMD-Enterprises)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/brands/{{ brand_list.json.results[0].brand_uuid }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          branding_title: "AMD-Enterprises"
          default_theme: "dark"
          flow_recovery: "{{ flow_recovery_id }}"
        status_code: [200]
      when: brand_list.json.results | length > 0

    # Flow Branding Updates (Title & Background) -----------------------------

    - name: Get Default Authentication Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=default-authentication-flow"
        method: GET
        headers: "{{ headers }}"
      register: auth_flow_list

    - name: Update Default Authentication Flow Branding
      ansible.builtin.uri:
        # Use slug for referencing
        url: "{{ authentik_url }}/api/v3/flows/instances/{{ auth_flow_list.json.results[0].slug }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          title: "Welcome to AMD-Enterprises"
          # User rejected black background. Keeping default (Mountain) or previous setting for now.
        status_code: [200]
      when: auth_flow_list.json.results | length > 0

    # MFA Implementation -----------------------------------------------------

    # 1. MFA Setup Stages
    - name: Create TOTP Setup Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/totp/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "MFA-TOTP-Setup"
          digits: 6
        status_code: [200, 201]
      ignore_errors: true
      register: create_totp_setup

    - name: Get TOTP Setup Stage (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/totp/?name=MFA-TOTP-Setup"
        method: GET
        headers: "{{ headers }}"
      register: get_totp_setup
      when: create_totp_setup.failed

    - name: Capture TOTP Stage ID
      ansible.builtin.set_fact:
        stage_totp_id: "{{ (create_totp_setup.json.pk if (create_totp_setup is defined and create_totp_setup.json is defined and create_totp_setup.json.pk is defined) else get_totp_setup.json.results[0].pk) }}"

    - name: Create WebAuthn Setup Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/webauthn/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "MFA-WebAuthn-Setup"
          user_verification: "preferred"
        status_code: [200, 201]
      ignore_errors: true
      register: create_webauthn_setup

    - name: Get WebAuthn Setup Stage (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/webauthn/?name=MFA-WebAuthn-Setup"
        method: GET
        headers: "{{ headers }}"
      register: get_webauthn_setup
      when: create_webauthn_setup.failed

    - name: Capture WebAuthn Stage ID
      ansible.builtin.set_fact:
        stage_webauthn_id: "{{ (create_webauthn_setup.json.pk if (create_webauthn_setup is defined and create_webauthn_setup.json is defined and create_webauthn_setup.json.pk is defined) else get_webauthn_setup.json.results[0].pk) }}"

    - name: Create Static Authenticator Stage (Backup Codes)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/static/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "MFA-Static-Setup"
          token_count: 6
        status_code: [200, 201]
      ignore_errors: true
      register: create_static_setup

    - name: Get Static Setup Stage (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/static/?name=MFA-Static-Setup"
        method: GET
        headers: "{{ headers }}"
      register: get_static_setup
      when: create_static_setup.failed

    - name: Capture Static Stage ID
      ansible.builtin.set_fact:
        stage_static_id: "{{ (create_static_setup.json.pk if (create_static_setup is defined and create_static_setup.json is defined and create_static_setup.json.pk is defined) else get_static_setup.json.results[0].pk) }}"

    # 2. MFA Setup Flow
    - name: Create MFA Setup Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "MFA Setup Flow"
          slug: "mfa-setup-flow"
          title: "Set up Multi-Factor Authentication"
          designation: "stage_configuration"
        status_code: [200, 201]
      ignore_errors: true
      register: create_mfa_flow

    - name: Get MFA Setup Flow (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=mfa-setup-flow"
        method: GET
        headers: "{{ headers }}"
      register: get_mfa_flow
      when: create_mfa_flow.failed

    - name: Capture MFA Setup Flow ID
      ansible.builtin.set_fact:
        flow_mfa_setup_id: "{{ (create_mfa_flow.json.pk if (create_mfa_flow is defined and create_mfa_flow.json is defined and create_mfa_flow.json.pk is defined) else get_mfa_flow.json.results[0].pk) }}"

    # 3. Bind Stages to Setup Flow
    - name: Bind TOTP to Setup Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_mfa_setup_id }}"
          stage: "{{ stage_totp_id }}"
          order: 10
        status_code: [200, 201]
      ignore_errors: true

    - name: Bind WebAuthn to Setup Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_mfa_setup_id }}"
          stage: "{{ stage_webauthn_id }}"
          order: 20
        status_code: [200, 201]
      ignore_errors: true

    - name: Bind Static (Backup Codes) to Setup Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_mfa_setup_id }}"
          stage: "{{ stage_static_id }}"
          order: 30
        status_code: [200, 201]
      ignore_errors: true

    # 4. Dedicated Backup Codes Flow (For "Enroll" Dropdown)
    - name: Create Backup Codes Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Enroll Backup Codes"
          slug: "enroll-backup-codes"
          title: "Generate Backup Codes"
          designation: "stage_configuration"
        status_code: [200, 201]
      ignore_errors: true
      register: create_backup_flow

    - name: Get Backup Codes Flow (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=enroll-backup-codes"
        method: GET
        headers: "{{ headers }}"
      register: get_backup_flow
      when: create_backup_flow.failed

    - name: Capture Backup Flow ID
      ansible.builtin.set_fact:
        flow_backup_id: "{{ (create_backup_flow.json.pk if (create_backup_flow is defined and create_backup_flow.json is defined and create_backup_flow.json.pk is defined) else get_backup_flow.json.results[0].pk) }}"

    - name: Bind Static Stage to Backup Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_backup_id }}"
          stage: "{{ stage_static_id }}"
          order: 10
        status_code: [200, 201]
      ignore_errors: true

    # 5. MFA Validation Stage (Login)
    - name: Create MFA Validation Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/validate/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "MFA-Validation"
          not_configured_action: "skip" # CRITICAL: Skips for Admins who haven't setup MFA
          device_classes:
            - static
            - totp
            - webauthn
        status_code: [200, 201]
      ignore_errors: true
      register: create_mfa_validate

    - name: Get MFA Validation Stage (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/authenticator/validate/?name=MFA-Validation"
        method: GET
        headers: "{{ headers }}"
      register: get_mfa_validate
      when: create_mfa_validate.failed

    - name: Capture MFA Validate Stage ID
      ansible.builtin.set_fact:
        stage_mfa_validate_id: "{{ (create_mfa_validate.json.pk if (create_mfa_validate is defined and create_mfa_validate.json is defined and create_mfa_validate.json.pk is defined) else get_mfa_validate.json.results[0].pk) }}"

    # 5. Bind MFA Validation to Default Authentication Flow
    - name: Bind MFA Validation to Login Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ auth_flow_list.json.results[0].pk }}"
          stage: "{{ stage_mfa_validate_id }}"
          order: 30 # Execute AFTER password
        status_code: [200, 201]
      ignore_errors: true

    # Invitation Flow Implementation ------------------------------------------

    # 1. Create Invitation Stage
    - name: Create Invitation Stage
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/invitation/stages/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Enrollment-Invitation-Stage"
        status_code: [200, 201]
      ignore_errors: true
      register: create_invitation

    - name: Get Invitation Stage (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/stages/invitation/stages/?name=Enrollment-Invitation-Stage"
        method: GET
        headers: "{{ headers }}"
      register: get_invitation
      when: create_invitation.failed

    - name: Capture Invitation Stage ID
      ansible.builtin.set_fact:
        stage_invitation_id: "{{ (create_invitation.json.pk if (create_invitation is defined and create_invitation.json is defined and create_invitation.json.pk is defined) else get_invitation.json.results[0].pk) }}"

    # 2. Get Default Enrollment Stages (Reuse)
    - name: Get Default Enrollment Prompt Stage
      ansible.builtin.uri:
        # Prompt stages endpoint requires /stages/ suffix
        url: "{{ authentik_url }}/api/v3/stages/prompt/stages/?slug=default-source-enrollment-prompt"
        method: GET
        headers: "{{ headers }}"
      register: default_prompt_list

    - name: Get Default Enrollment Write Stage
      ansible.builtin.uri:
        # user_write endpoint does NOT require /stages/ suffix like prompt
        url: "{{ authentik_url }}/api/v3/stages/user_write/?slug=default-source-enrollment-write"
        method: GET
        headers: "{{ headers }}"
      register: default_write_list

    - name: Get Default Enrollment Login Stage
      ansible.builtin.uri:
        # user_login endpoint does NOT require /stages/ suffix
        url: "{{ authentik_url }}/api/v3/stages/user_login/?slug=default-source-enrollment-login"
        method: GET
        headers: "{{ headers }}"
      register: default_login_list

    # 3. Create Invitation Flow
    - name: Create Invitation Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Invitation Flow"
          slug: "enrollment-invitation"
          title: "Redeem Invitation"
          designation: "enrollment"
        status_code: [200, 201]
      ignore_errors: true
      register: create_invitation_flow

    - name: Get Invitation Flow (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=enrollment-invitation"
        method: GET
        headers: "{{ headers }}"
      register: get_invitation_flow
      when: create_invitation_flow.failed

    - name: Capture Invitation Flow ID
      ansible.builtin.set_fact:
        flow_invitation_id: "{{ (create_invitation_flow.json.pk if (create_invitation_flow is defined and create_invitation_flow.json is defined and create_invitation_flow.json.pk is defined) else get_invitation_flow.json.results[0].pk) }}"

    # 4. Bind Stages
    - name: Bind Invitation Stage (Order 0)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_invitation_id }}"
          stage: "{{ stage_invitation_id }}"
          order: 0
        status_code: [200, 201]
      ignore_errors: true

    - name: Bind Default Prompt (Order 10)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_invitation_id }}"
          stage: "{{ default_prompt_list.json.results[0].pk }}"
          order: 10
        status_code: [200, 201]
      ignore_errors: true
      when: default_prompt_list.json.results | length > 0

    - name: Bind Default Write (Order 20)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_invitation_id }}"
          stage: "{{ default_write_list.json.results[0].pk }}"
          order: 20
        status_code: [200, 201]
      ignore_errors: true
      when: default_write_list.json.results | length > 0

    - name: Bind Default Login (Order 30)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ flow_invitation_id }}"
          stage: "{{ default_login_list.json.results[0].pk }}"
          order: 30
        status_code: [200, 201]
      ignore_errors: true
      when: default_login_list.json.results | length > 0

    # Proxy Protection Implementation (Demo App) -----------------------------

    # 1. Get Authorization Flow (Implicit Consent)
    - name: Get Implicit Consent Flow
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/flows/instances/?slug=default-provider-authorization-implicit-consent"
        method: GET
        headers: "{{ headers }}"
      register: flow_implicit_consent

    # 2. Create Proxy Provider
    - name: Create WhoAmI Proxy Provider
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/proxy/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "WhoAmI Provider"
          authorization_flow: "{{ flow_implicit_consent.json.results[0].pk }}"
          mode: "forward_single" # Forward Auth (Single Application)
          external_host: "https://whoami.chi.lab.amd-e.com"
          internal_host: "http://127.0.0.1:8080" # Not strict for forward_auth single, but good practice
        status_code: [200, 201]
      ignore_errors: true
      register: create_whoami_provider

    - name: Get WhoAmI Provider (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/proxy/?search=WhoAmI%20Provider"
        method: GET
        headers: "{{ headers }}"
      register: get_whoami_provider
      when: create_whoami_provider.failed

    - name: Capture WhoAmI Provider ID
      ansible.builtin.set_fact:
        whoami_provider_id: "{{ (create_whoami_provider.json.pk if (create_whoami_provider is defined and create_whoami_provider.json is defined and create_whoami_provider.json.pk is defined) else get_whoami_provider.json.results[0].pk) }}"

    - name: Update WhoAmI Provider (Ensure DNS hostname)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/providers/proxy/{{ whoami_provider_id }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          external_host: "https://whoami.chi.lab.amd-e.com"
          internal_host: "http://127.0.0.1:8080"
        status_code: [200]

    # 3. Create Application
    - name: Create WhoAmI Application
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "WhoAmI Demo"
          slug: "whoami"
          provider: "{{ whoami_provider_id }}"
          meta_launch_url: "https://whoami.chi.lab.amd-e.com"
          group: "" # No specific group, allow all authenticated? Or explicit binding?
        status_code: [200, 201]
      ignore_errors: true
      register: create_whoami_app

    - name: Get WhoAmI Application (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/core/applications/?slug=whoami"
        method: GET
        headers: "{{ headers }}"
      register: get_whoami_app
      when: create_whoami_app.failed

    - name: Capture WhoAmI App ID
      ansible.builtin.set_fact:
        whoami_app_id: "{{ (create_whoami_app.json.pk if (create_whoami_app is defined and create_whoami_app.json is defined and create_whoami_app.json.pk is defined) else get_whoami_app.json.results[0].pk) }}"

    - name: Update WhoAmI Application (Ensure Launch URL)
      ansible.builtin.uri:
        # Use slug 'whoami' directly to avoid stale ID issues
        url: "{{ authentik_url }}/api/v3/core/applications/whoami/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          meta_launch_url: "https://whoami.chi.lab.amd-e.com"
        status_code: [200]

    # 4. Bind Provider to Embedded Outpost (Critical for Forward Auth)
    - name: Get Embedded Outpost
      ansible.builtin.uri:
        # Search for "authentik Embedded Outpost" needs encoding or simply search by generic list and filtering?
        # Search param often handles spaces but uri module might need encoding.
        url: "{{ authentik_url }}/api/v3/outposts/instances/?search=authentik%20Embedded%20Outpost"
        method: GET
        headers: "{{ headers }}"
      register: embedded_outpost

    - name: Update Embedded Outpost (Add Provider)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/outposts/instances/{{ embedded_outpost.json.results[0].pk }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          # Append new provider ID to existing list. Uses 'providers' (list of IDs).
          # Convert existing list of IDs (which might be integers) to list, add new ID.
          providers: "{{ embedded_outpost.json.results[0].providers + [whoami_provider_id] | unique }}"
        status_code: [200]
      when: whoami_provider_id not in embedded_outpost.json.results[0].providers

    # 5. MFA Enforcement Policy (Restrict App Access)
    - name: Get Require MFA Policy (Idempotency)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/expression/?search=Require%20MFA"
        method: GET
        headers: "{{ headers }}"
      register: get_mfa_policy

    - name: Create Require MFA Policy
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/expression/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          name: "Require MFA"
          expression: |
            # Debugging MFA counts
            totp = len(request.user.totp_devices.all())
            webauthn = len(request.user.webauthn_devices.all())
            static = len(request.user.static_devices.all())
            ak_logger.warning(f"MFA Policy Debug: User={request.user.username}, TOTP={totp}, WebAuthn={webauthn}, Static={static}")
            return totp > 0 or webauthn > 0 or static > 0
        status_code: [200, 201]
      when: get_mfa_policy.json.results | length == 0
      register: create_mfa_policy
      changed_when: true

    - name: Update Require MFA Policy (Ensure Debug Expression)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/expression/{{ get_mfa_policy.json.results[0].pk }}/"
        method: PATCH
        headers: "{{ headers }}"
        body_format: json
        body:
          expression: |
            # Direct DB Query using Authentik stages (Verified Imports)
            # This avoids 'ModuleNotFoundError: No module named django_otp'
            from authentik.stages.authenticator_totp.models import TOTPDevice
            from authentik.stages.authenticator_static.models import StaticDevice
            from authentik.stages.authenticator_webauthn.models import WebAuthnDevice

            # WebAuthn doesn't have a 'confirmed' field usually, but we check existence
            has_totp = TOTPDevice.objects.filter(user=request.user, confirmed=True).exists()
            has_static = StaticDevice.objects.filter(user=request.user, confirmed=True).exists()
            has_webauthn = WebAuthnDevice.objects.filter(user=request.user).exists()

            return has_totp or has_static or has_webauthn
        status_code: [200]
      when: get_mfa_policy.json.results | length > 0

    - name: Capture MFA Policy ID
      ansible.builtin.set_fact:
        mfa_policy_id: "{{ (create_mfa_policy.json.pk if (create_mfa_policy is defined and create_mfa_policy.json is defined and create_mfa_policy.json.pk is defined) else get_mfa_policy.json.results[0].pk) }}"

    - name: Check MFA Policy Binding (Proxmox)
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/bindings/?target={{ proxmox_app_id }}&policy={{ mfa_policy_id }}"
        method: GET
        headers: "{{ headers }}"
      register: get_mfa_binding

    - name: Bind MFA Policy to Proxmox App
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/policies/bindings/"
        method: POST
        headers: "{{ headers }}"
        body_format: json
        body:
          target: "{{ proxmox_app_id }}"
          policy: "{{ mfa_policy_id }}"
          order: 0
          enabled: true
          negate: false
        status_code: [200, 201]
      when: get_mfa_binding.json.results | length == 0
