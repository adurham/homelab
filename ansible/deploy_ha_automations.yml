---
- name: Deploy Home Assistant Automations
  hosts: homeassistant
  gather_facts: false # No python on HA OS usually
  vars:
    # Use playbook_dir to ensure paths are correct regardless of where ansible-playbook is run
    local_automations_dir: "{{ playbook_dir }}/../homeassistant/automations/"

  tasks:
    - name: Ensure target directory exists
      raw: "mkdir -p /config/automations"
      register: mkdir_result
      changed_when: mkdir_result.rc == 0

    - name: Copy Files (Automations, Templates, Sensors)
      ansible.builtin.shell: >
        scp -P {{ ansible_port }} -o StrictHostKeyChecking=no {{ local_automations_dir }}/*.yaml {{ ansible_user }}@{{ ansible_host }}:/config/automations/ && \
        scp -P {{ ansible_port }} -o StrictHostKeyChecking=no {{ playbook_dir }}/../homeassistant/templates.yaml {{ ansible_user }}@{{ ansible_host }}:/config/ && \
        scp -P {{ ansible_port }} -o StrictHostKeyChecking=no {{ playbook_dir }}/../homeassistant/sensors.yaml {{ ansible_user }}@{{ ansible_host }}:/config/
      delegate_to: localhost
      register: scp_result
      changed_when: scp_result.rc == 0

    - name: Check Configuration
      raw: "ha core check"
      register: config_check
      changed_when: false
      failed_when: "'Command completed successfully' not in config_check.stdout and config_check.rc != 0"

    - name: Restart Core
      raw: "ha core restart"
      register: restart_core
      changed_when: restart_core.rc == 0
