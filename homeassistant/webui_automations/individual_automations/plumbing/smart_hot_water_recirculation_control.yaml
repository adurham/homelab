# Smart Hot Water Recirculation Control
# ID: 1752541400967
# Category: plumbing
# Description: Runs the recirculation pump on-demand with a global cooldown and separate

- id: '1752541400967'
  alias: Smart Hot Water Recirculation Control
  description: Runs the recirculation pump on-demand with a global cooldown and separate
    logic for day and night.
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.guest_bathroom_occupancy
    - binary_sensor.half_bathroom_occupancy
    - binary_sensor.kitchen_occupancy_2
    - binary_sensor.main_bathroom_occupancy
    from: 'off'
    to: 'on'
  conditions:
  - condition: state
    entity_id: timer.water_heater_circulator_pump_cooldown
    state: idle
  actions:
  - target:
      entity_id: timer.water_heater_circulator_pump_cooldown
    action: timer.start
    data: {}
  - repeat:
      sequence:
      - choose:
        - conditions:
          - condition: sun
            after: sunset
          - condition: or
            conditions:
            - condition: state
              entity_id: switch.kitchen_main_lights
              state: 'on'
            - condition: state
              entity_id: switch.guest_bathroom_vanity_lights
              state: 'on'
            - condition: state
              state: 'on'
              entity_id: switch.half_bathroom_vanity_lights
          sequence:
          - action: switch.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: switch.shelly1minig3_28372f21c1dc
          - delay:
              hours: 0
              minutes: 5
              seconds: 0
              milliseconds: 0
          - action: switch.turn_off
            metadata: {}
            data: {}
            target:
              entity_id: switch.shelly1minig3_28372f21c1dc
        - conditions:
          - condition: sun
            after: sunrise
          sequence:
          - action: switch.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: switch.shelly1minig3_28372f21c1dc
          - delay:
              hours: 0
              minutes: 5
              seconds: 0
              milliseconds: 0
          - action: switch.turn_off
            metadata: {}
            data: {}
            target:
              entity_id: switch.shelly1minig3_28372f21c1dc
      - delay:
          hours: 0
          minutes: 25
          seconds: 0
          milliseconds: 0
      while:
      - condition: or
        conditions:
        - condition: state
          entity_id: binary_sensor.guest_bathroom_occupancy
          state: 'on'
        - condition: state
          entity_id: binary_sensor.half_bathroom_occupancy
          state: 'on'
        - condition: state
          state: 'on'
          entity_id: binary_sensor.kitchen_occupancy_2
        - condition: state
          entity_id: binary_sensor.main_bathroom_occupancy
          state: 'on'
  mode: single