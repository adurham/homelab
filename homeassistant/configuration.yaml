# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
automation custom: !include_dir_merge_list automations/
script: !include scripts.yaml
script custom: !include_dir_merge_list scripts/
scene: !include scenes.yaml
scene custom: !include_dir_merge_list scenes/

# Helper Entities
input_boolean:
  water_heater_pump_automation_enabled:
    name: "Water Heater Pump Automation"
    icon: mdi:water-pump
  water_heater_pump_kitchen_priority:
    name: "Water Heater Pump Kitchen Priority"
    icon: mdi:stove
  water_heater_pump_low_temp_lockout:
    name: "Water Heater Pump Low Temperature Lockout"
    icon: mdi:thermometer-low
    initial: false
  water_heater_recovery_mode:
    name: "Water Heater Recovery Mode"
    icon: mdi:flash
    initial: false
  basement_heatpump_occupancy_control_enabled:
    name: "Basement Heat Pump Occupancy Control"
    icon: mdi:motion-sensor
    initial: true

input_number:
  water_heater_pump_daily_runtime_hours:
    name: "Water Heater Pump Daily Runtime"
    min: 0
    max: 24
    step: 0.25
    unit_of_measurement: "hours"
    icon: mdi:clock
  basement_virtual_setpoint:
    name: "Basement Virtual Setpoint"
    min: 60
    max: 80
    step: 1
    unit_of_measurement: "째F"
    icon: mdi:thermostat
    initial: 70
  water_heater_min_temp_threshold:
    name: "Minimum Temperature for Circulation"
    min: 90
    max: 120
    step: 1
    unit_of_measurement: "째F"
    icon: mdi:thermometer
    initial: 100
  water_heater_critical_hot_water_threshold:
    name: "Critical Hot Water Threshold"
    min: 0
    max: 50
    step: 5
    unit_of_measurement: "%"
    icon: mdi:water-percent-alert
    initial: 30
  water_heater_pump_temp_drop_threshold:
    name: "Pump Stop Temperature Drop Threshold"
    min: 3
    max: 15
    step: 1
    unit_of_measurement: "째F"
    icon: mdi:thermometer-chevron-down
    initial: 5
  water_heater_pump_start_lower_temp:
    name: "Pump Start Lower Tank Temperature"
    min: 50
    max: 130
    step: 0.1
    unit_of_measurement: "째F"
    icon: mdi:thermometer
    initial: 100
  basement_heatpump_unoccupied_delay:
    name: "Basement Heat Pump Unoccupied Delay"
    min: 0
    max: 120
    step: 5
    unit_of_measurement: "minutes"
    icon: mdi:timer-off
    initial: 30

input_select:
  basement_virtual_mode:
    name: "Basement Virtual Mode"
    options:
      - "auto"
      - "heat"
      - "cool"
      - "off"
    icon: mdi:sync
    initial: "auto"

counter:
  water_heater_pump_daily_cycles:
    name: "Water Heater Pump Daily Cycles"
    initial: 0
    step: 1
    icon: mdi:counter

timer:
  water_heater_pump_runtime:
    name: "Water Heater Pump Runtime"
    duration: "00:15:00"
    icon: mdi:timer
  water_heater_pump_cooldown:
    name: "Water Heater Pump Cooldown"
    duration: "00:45:00"
    icon: mdi:timer-pause
  garage_lights_motion_timeout:
    name: "Garage Lights Motion Timeout"
    duration: "00:15:00"
    icon: mdi:timer

influxdb:
  host: a0d7b954-influxdb
  port: 8086
  database: homeassistant
  username: !secret influxdb_username
  password: !secret influxdb_password
  max_retries: 3
  default_measurement: state
  component_config_glob:
    sensor.*:
      override_measurement: state
  include:
    domains:
      - sensor
      - binary_sensor
      - switch
      - counter
      - input_number
    entities:
      - sensor.water_heater_pump_daily_runtime_hours
      - input_number.water_heater_pump_daily_runtime_hours
  exclude:
    domains:
      - media_player  # Huge bloat (album art/titles)
      - device_tracker # Huge bloat (location history)
    entity_globs:
      - sensor.clock*
      - sensor.date*
      - sensor.time*
      - sensor.uptime*
      - sensor.*_signal_strength
      - sensor.*_ssid
      - sensor.*_bssid
      - sensor.*_battery_level # Optional: remove if you care about battery history
    entities:
      - sun.sun

template:
  - sensor:
      - name: "Water Heater Pump Daily Runtime Hours"
        unique_id: water_heater_pump_daily_runtime_hours_sensor
        state: "{{ states('input_number.water_heater_pump_daily_runtime_hours') | float(0) }}"
        unit_of_measurement: "hours"
        icon: mdi:clock
        device_class: duration
  - switch:
      - name: "Basement Heatpump Heat"
        unique_id: basement_heatpump_heat_switch
        icon: mdi:radiator
        availability: >-
          {{ states('climate.basement_heatpump_basement_office_ac') not in
          ['unavailable', 'unknown'] }}
        state: >-
          {{ 'on' if is_state_attr('climate.basement_heatpump_basement_office_ac',
          'hvac_mode', 'heat') else 'off' }}
        turn_on:
          - service: climate.set_hvac_mode
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              hvac_mode: 'heat'
          - service: climate.set_swing_mode
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              swing_mode: vertical
          - service: climate.set_temperature
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              temperature: 86
        turn_off:
          - service: climate.set_hvac_mode
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              hvac_mode: 'off'
      - name: "Basement Heatpump Cool"
        unique_id: basement_heatpump_cool_switch
        icon: mdi:snowflake
        availability: >-
          {{ states('climate.basement_heatpump_basement_office_ac') not in
          ['unavailable', 'unknown'] }}
        state: >-
          {{ 'on' if is_state_attr('climate.basement_heatpump_basement_office_ac',
          'hvac_mode', 'cool') else 'off' }}
        turn_on:
          - service: climate.set_hvac_mode
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              hvac_mode: 'cool'
          - service: climate.set_swing_mode
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              swing_mode: vertical
          - service: climate.set_temperature
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              temperature: 60
        turn_off:
          - service: climate.set_hvac_mode
            data:
              entity_id: climate.basement_heatpump_basement_office_ac
              hvac_mode: 'off'

climate:
  - platform: generic_thermostat
    name: Basement Virtual Thermostat
    unique_id: basement_virtual_thermostat
    heater: switch.basement_heatpump_heat
    ac_mode: false
    target_sensor: sensor.7wq7_temperature
    min_temp: 60
    max_temp: 80
    cold_tolerance: 0.5
    hot_tolerance: 0.5
    initial_hvac_mode: "off"
  - platform: generic_thermostat
    name: Basement Virtual AC
    unique_id: basement_virtual_ac
    heater: switch.basement_heatpump_cool
    ac_mode: true
    target_sensor: sensor.7wq7_temperature
    min_temp: 60
    max_temp: 80
    cold_tolerance: 0.5
    hot_tolerance: 0.5
    initial_hvac_mode: "off"
