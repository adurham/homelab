---
# Water Heater - Smart Mode Control
# Switches between Heat Pump and High Demand modes based on hot water availability
- id: 'water_heater_smart_mode_control'
  alias: 'Water Heater - Smart Mode Control'
  description: 'Automatically switches heating modes based on hot water availability'
  triggers:
    - platform: numeric_state
      entity_id: sensor.econet_hpwh_hot_water
      below: input_number.water_heater_critical_hot_water_threshold
      id: 'low_hot_water'
    - platform: numeric_state
      entity_id: sensor.econet_hpwh_hot_water
      above: input_number.water_heater_critical_hot_water_threshold
      for:
        minutes: 2
      id: 'recovered_hot_water'
  action:
    - variables:
        hot_water_percent: "{{ states('sensor.econet_hpwh_hot_water') | float(0) }}"
        critical_threshold: "{{ states('input_number.water_heater_critical_hot_water_threshold') | float(30) }}"
        current_preset: "{{ state_attr('climate.econet_hpwh', 'preset_mode') }}"
    - choose:
        # Hot water critically low - switch to High Demand
        - conditions:
            - condition: trigger
              id: 'low_hot_water'
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.water_heater_recovery_mode
            - service: system_log.write
              data:
                message: >-
                  Water heater entering recovery mode - Hot water: {{ hot_water_percent }}%
                  (threshold: {{ critical_threshold }}%) - Switching to High Demand mode
                level: warning
            - service: climate.set_preset_mode
              target:
                entity_id: climate.econet_hpwh
              data:
                preset_mode: 'High Demand'
        
        # Hot water recovered - switch back to Heat Pump
        - conditions:
            - condition: trigger
              id: 'recovered_hot_water'
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.water_heater_recovery_mode
            - service: system_log.write
              data:
                message: >-
                  Water heater recovery complete - Hot water: {{ hot_water_percent }}%
                  (threshold: {{ critical_threshold }}%) - Switching to Heat Pump mode
                level: info
            - service: climate.set_preset_mode
              target:
                entity_id: climate.econet_hpwh
              data:
                preset_mode: 'Heat Pump'
  mode: single
