# Water Heater Circulator Pump - Runtime Update
# Updates daily runtime when pump turns off
- id: 'water_heater_pump_runtime_update'
  alias: 'Water Heater Pump - Runtime Update'
  description: 'Updates daily runtime when pump turns off'
  triggers:
    - platform: state
      entity_id: switch.shelly1minig3_28372f21c1dc
      to: 'off'
  action:
    - variables:
        runtime_seconds: >-
          {% set from_ts = as_timestamp(trigger.from_state.last_changed) if trigger.from_state else None %}
          {% set to_ts = as_timestamp(trigger.to_state.last_changed) if trigger.to_state else None %}
          {% if from_ts is not none and to_ts is not none %}
            {% set delta = to_ts - from_ts %}
            {{ 0 if delta < 0 else delta }}
          {% else %}
            0
          {% endif %}
        runtime_hours: "{{ (runtime_seconds / 3600) | round(3) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.water_heater_pump_daily_runtime_hours
      data:
        value: "{{ (states('input_number.water_heater_pump_daily_runtime_hours') | float + runtime_hours) | round(2) }}"
    - service: system_log.write
      data:
        message: >-
          Water heater pump stopped - Incremented runtime by {{ (runtime_hours * 60) | round(1) }} minutes.
          Daily total: {{ states("input_number.water_heater_pump_daily_runtime_hours") }}h
        level: info
  mode: single
