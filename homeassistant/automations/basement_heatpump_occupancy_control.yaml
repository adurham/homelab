---
# Basement Heat Pump - Occupancy-Based Control
# Turns off heat pump when basement is unoccupied to save energy
- id: basement_heatpump_occupancy_control
  alias: Basement Heat Pump - Occupancy Control
  description: Turn off heat pump when basement unoccupied, resume when occupied
  mode: restart
  triggers:
    - platform: state
      entity_id: binary_sensor.7wq7_occupancy
      to: 'off'
      id: 'occupancy_off'
    - platform: state
      entity_id: switch.basement_lights
      to: 'off'
      id: 'lights_off'
    - platform: state
      entity_id: binary_sensor.7wq7_occupancy
      to: 'on'
      id: 'occupancy_on'
    - platform: state
      entity_id: switch.basement_lights
      to: 'on'
      id: 'lights_on'
  conditions:
    - condition: state
      entity_id: input_boolean.basement_heatpump_occupancy_control_enabled
      state: 'on'
  action:
    - variables:
        is_occupied: >-
          {{ is_state('binary_sensor.7wq7_occupancy', 'on') or 
             is_state('switch.basement_lights', 'on') }}
        delay_minutes: "{{ states('input_number.basement_heatpump_unoccupied_delay') | int(30) }}"
    - choose:
        # Basement became unoccupied - wait delay then turn off
        - conditions:
            - condition: template
              value_template: "{{ not is_occupied }}"
            - condition: trigger
              id:
                - 'occupancy_off'
                - 'lights_off'
          sequence:
            - service: system_log.write
              data:
                message: >-
                  Basement unoccupied - waiting {{ delay_minutes }} minutes before turning off heat pump
                level: info
            - delay:
                minutes: "{{ delay_minutes }}"
            # Check again after delay
            - condition: template
              value_template: >-
                {{ is_state('binary_sensor.7wq7_occupancy', 'off') and
                   is_state('switch.basement_lights', 'off') }}
            - service: system_log.write
              data:
                message: 'Basement still unoccupied after delay - turning off heat pump'
                level: info
            - service: climate.turn_off
              target:
                entity_id:
                  - climate.basement_virtual_thermostat
                  - climate.basement_virtual_ac
        
        # Basement became occupied - turn on to previous setpoint
        - conditions:
            - condition: template
              value_template: "{{ is_occupied }}"
            - condition: trigger
              id:
                - 'occupancy_on'
                - 'lights_on'
          sequence:
            - service: system_log.write
              data:
                message: 'Basement occupied - resuming heat pump operation'
                level: info
            # Resume based on basement_virtual_mode
            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_select.basement_virtual_mode
                      state: 'heat'
                  sequence:
                    - service: climate.set_hvac_mode
                      target:
                        entity_id: climate.basement_virtual_thermostat
                      data:
                        hvac_mode: 'heat'
                - conditions:
                    - condition: state
                      entity_id: input_select.basement_virtual_mode
                      state: 'cool'
                  sequence:
                    - service: climate.set_hvac_mode
                      target:
                        entity_id: climate.basement_virtual_ac
                      data:
                        hvac_mode: 'heat'
                - conditions:
                    - condition: state
                      entity_id: input_select.basement_virtual_mode
                      state: 'auto'
                  sequence:
                    # Auto mode - turn on heat if temp is low
                    - choose:
                        - conditions:
                            - condition: numeric_state
                              entity_id: sensor.7wq7_temperature
                              below: input_number.basement_virtual_setpoint
                          sequence:
                            - service: climate.set_hvac_mode
                              target:
                                entity_id: climate.basement_virtual_thermostat
                              data:
                                hvac_mode: 'heat'
                        - conditions:
                            - condition: numeric_state
                              entity_id: sensor.7wq7_temperature
                              above: input_number.basement_virtual_setpoint
                          sequence:
                            - service: climate.set_hvac_mode
                              target:
                                entity_id: climate.basement_virtual_ac
                              data:
                                hvac_mode: 'heat'
  mode: restart
