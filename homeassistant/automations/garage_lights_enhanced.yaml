# Final Garage Lights - Multi-Door Motion Control
# EXACTLY what you requested:
# 1. Any of 3 garage doors opens AND light isn't already on â†’ turn light on
# 2. Turn off 15 minutes after motion sensor stops detecting motion

- id: 'garage_lights_final'
  alias: 'Garage Lights - Multi-Door Motion Control'
  description: 'Turns lights on when any garage door opens (if not already on), turns off 15 minutes after last motion'
  triggers:
    # Trigger when any of the 3 garage doors opens
    - platform: state
      entity_id:
        - cover.left_garage_door
        - cover.middle_garage_bay_door
        - cover.right_garage_bay_door
      to: 'open'
      id: garage_door_opened
    # Trigger when motion is detected (to reset the timer)
    - platform: state
      entity_id: binary_sensor.garage_door_motion
      to: 'on'
      id: motion_detected
  action:
    - choose:
        # When garage door opens - turn on lights ONLY if not already on
        - conditions:
            - condition: trigger
              id: garage_door_opened
            - condition: state
              entity_id: switch.garage_main_lights
              state: 'off'
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.garage_main_lights
            - service: system_log.write
              data:
                message: 'Garage lights turned on - door opened (was off)'
                level: info
        # When garage door opens but lights already on - just log
        - conditions:
            - condition: trigger
              id: garage_door_opened
            - condition: state
              entity_id: switch.garage_main_lights
              state: 'on'
          sequence:
            - service: system_log.write
              data:
                message: 'Garage door opened but lights already on - no action needed'
                level: info
        # When motion detected - log and continue to timer
        - conditions:
            - condition: trigger
              id: motion_detected
          sequence:
            - service: system_log.write
              data:
                message: 'Garage motion detected - resetting 15-minute timer'
                level: info
    # Wait 15 minutes
    - delay: '00:15:00'
    # Check if motion occurred during the 15-minute wait
    - condition: state
      entity_id: binary_sensor.garage_door_motion
      state: 'off'
      for:
        minutes: 1
    # Turn off lights if no recent motion
    - service: switch.turn_off
      target:
        entity_id: switch.garage_main_lights
    - service: system_log.write
      data:
        message: 'Garage lights turned off - 15 minutes after last motion'
        level: info
  mode: restart
