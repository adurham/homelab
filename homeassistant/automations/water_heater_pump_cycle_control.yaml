# Water Heater Circulator Pump - Cycle Control
# Manages dynamic runtime and cooldown window
- id: 'water_heater_pump_cycle_control'
  alias: 'Water Heater Pump - Cycle Control'
  description: 'Controls the pump cycle with dynamic runtime and cooldown handling'
  triggers:
    - platform: event
      event_type: automation.water_heater_pump_presence_detected
  conditions:
    - condition: state
      entity_id: input_boolean.water_heater_pump_automation_enabled
      state: 'on'
    - condition: state
      entity_id: timer.water_heater_pump_cooldown
      state: 'idle'
  action:
    - variables:
        kitchen_priority: "{{ is_state('input_boolean.water_heater_pump_kitchen_priority', 'on') }}"
        runtime_duration: "{{ '00:20:00' if kitchen_priority else '00:15:00' }}"
    - service: system_log.write
      data:
        message: >-
          Starting water heater pump cycle - Target runtime {{ runtime_duration }} (kitchen priority:
          {{ 'enabled' if kitchen_priority else 'disabled' }})
        level: info
    - service: switch.turn_on
      target:
        entity_id: switch.shelly1minig3_28372f21c1dc
    - service: timer.start
      target:
        entity_id: timer.water_heater_pump_runtime
      data:
        duration: "{{ runtime_duration }}"
    - service: automation.trigger
      target:
        entity_id: automation.water_heater_pump_turn_off
  mode: single
