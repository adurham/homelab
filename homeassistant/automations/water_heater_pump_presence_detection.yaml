# Water Heater Circulator Pump - Presence Detection
# Triggers when ANY bathroom/kitchen occupancy is detected OR kitchen lights are turned on
- id: 'water_heater_pump_presence_detected'
  alias: 'Water Heater Pump - Presence Detected'
  description: 'Detects presence in any room with a sink and starts pump cycle'
  triggers:
    - platform: state
      entity_id:
        - binary_sensor.kitchen_occupancy
        - binary_sensor.half_bathroom_occupancy
        - binary_sensor.main_bathroom_occupancy
        - binary_sensor.guest_bathroom_occupancy
      to: 'on'
    - platform: state
      entity_id:
        - switch.kitchen_main_lights
      to: 'on'
  conditions:
    - condition: state
      entity_id: input_boolean.water_heater_pump_automation_enabled
      state: 'on'
  action:
    - variables:
        kitchen_entities:
          - binary_sensor.kitchen_occupancy
          - switch.kitchen_main_lights
        is_kitchen_trigger: "{{ trigger.entity_id in kitchen_entities }}"
        pump_running: "{{ is_state('switch.shelly1minig3_28372f21c1dc', 'on') }}"
        cooldown_idle: "{{ is_state('timer.water_heater_pump_cooldown', 'idle') }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ pump_running }}"
          sequence:
            - service: system_log.write
              data:
                message: >-
                  Water heater pump presence detected from {{ trigger.entity_id }} but pump already
                  running - ignoring
                level: info
            - stop: 'Water heater pump already running'
        - conditions:
            - condition: template
              value_template: "{{ (not is_kitchen_trigger) and (not cooldown_idle) }}"
          sequence:
            - service: system_log.write
              data:
                message: >-
                  Water heater pump presence detected from {{ trigger.entity_id }} but cooldown active
                  - ignoring non-kitchen trigger
                level: info
            - stop: 'Water heater pump cooldown active for non-kitchen trigger'
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ is_kitchen_trigger }}"
          sequence:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ not cooldown_idle }}"
                  sequence:
                    - service: system_log.write
                      data:
                        message: 'Kitchen priority override - canceling cooldown timer to warm kitchen branch'
                        level: info
                    - service: timer.cancel
                      target:
                        entity_id: timer.water_heater_pump_cooldown
                    - delay: '00:00:01'
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.water_heater_pump_kitchen_priority
      default:
        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.water_heater_pump_kitchen_priority
    - service: system_log.write
      data:
        message: >-
          Water heater pump presence detected - Trigger: {{ trigger.to_state.attributes.friendly_name
          if trigger.to_state.attributes.friendly_name else trigger.entity_id }} ({{ trigger.entity_id
          }})
          Kitchen priority: {{ 'yes' if is_state('input_boolean.water_heater_pump_kitchen_priority',
          'on') else 'no' }}
        level: info
    - service: automation.trigger
      target:
        entity_id: automation.water_heater_pump_cycle_control
  mode: single
