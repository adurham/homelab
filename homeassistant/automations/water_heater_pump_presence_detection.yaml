# Water Heater Circulator Pump - Presence Detection
# Triggers when ANY bathroom/kitchen occupancy is detected OR kitchen lights are turned on
- id: 'water_heater_pump_presence_detected'
  alias: 'Water Heater Pump - Presence Detected'
  description: 'Detects presence in any room with a sink and starts pump cycle'
  triggers:
    - platform: state
      entity_id:
        - binary_sensor.kitchen_occupancy
        - binary_sensor.half_bathroom_occupancy
        - binary_sensor.main_bathroom_occupancy
        - binary_sensor.guest_bathroom_occupancy
      to: 'on'
    - platform: state
      entity_id:
        - switch.kitchen_main_lights
      to: 'on'
  conditions:
    - condition: state
      entity_id: input_boolean.water_heater_pump_automation_enabled
      state: 'on'
  action:
    - variables:
        pump_running: "{{ is_state('switch.shelly1minig3_28372f21c1dc', 'on') }}"
        cooldown_idle: "{{ is_state('timer.water_heater_pump_cooldown', 'idle') }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ pump_running }}"
          sequence:
            - service: system_log.write
              data:
                message: >-
                  Water heater pump presence detected from {{ trigger.entity_id }} but pump already
                  running - ignoring
                level: info
            - stop: 'Water heater pump already running'
        - conditions:
            - condition: template
              value_template: "{{ not cooldown_idle }}"
          sequence:
            - service: system_log.write
              data:
                message: >-
                  Water heater pump presence detected from {{ trigger.entity_id }} but cooldown active
                  - ignoring
                level: info
            - stop: 'Water heater pump cooldown active'
    - service: system_log.write
      data:
        message: >-
          Water heater pump presence detected - Trigger: {{ trigger.to_state.attributes.friendly_name
          if trigger.to_state.attributes.friendly_name else trigger.entity_id }} ({{ trigger.entity_id
          }})
        level: info
    - service: automation.trigger
      target:
        entity_id: automation.water_heater_pump_cycle_control
  mode: single

